import { useAuth } from "@/hooks/use-auth";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import {
  Store,
  Upload,
  BarChart3,
  Package,
  Trash2,
  Calendar,
  CheckSquare,
  FileText,
  LogOut,
  Archive,
  GitMerge,
  Package2,
  Settings,
  BookOpen,
  ShoppingCart,
  Database,
  Building2,
  Wrench,
  LayoutDashboard,
  Sparkles,
  Grid3x3
} from "lucide-react";
import type { DashboardTab } from "@/pages/dashboard";

interface SidebarProps {
  activeTab: DashboardTab;
  onTabChange: (tab: DashboardTab) => void;
  isOpen?: boolean;
  onClose?: () => void;
}

const navigationItems = [
  { id: 'dashboard' as DashboardTab, label: 'Dashboard', icon: BarChart3 },
  { id: 'widget-dashboards' as DashboardTab, label: 'Widget Dashboards', icon: LayoutDashboard },
  { id: 'widget-builder' as DashboardTab, label: 'Widget Builder', icon: Sparkles },
  { id: 'widget-templates' as DashboardTab, label: 'Widget Templates', icon: Grid3x3 },
  { id: 'stock' as DashboardTab, label: 'Stock Control', icon: Package },
  { id: 'stock-ordering' as DashboardTab, label: 'Stock Ordering', icon: ShoppingCart },
  { id: 'sales' as DashboardTab, label: 'Sales Analytics', icon: BarChart3 },
  { id: 'case-sizes' as DashboardTab, label: 'Case Size Management', icon: Package2 },
  { id: 'stock-profiles' as DashboardTab, label: 'Stock Profiles', icon: Archive },
  { id: 'supplier-profiles' as DashboardTab, label: 'Supplier Profiles', icon: Building2 },
  { id: 'sales-aggregation' as DashboardTab, label: 'Sales Aggregation', icon: GitMerge },
  { id: 'waste' as DashboardTab, label: 'Waste Management', icon: Trash2 },
  { id: 'bbd-dashboard' as DashboardTab, label: 'Expiry Management', icon: Database },
  { id: 'tasks' as DashboardTab, label: 'Tasks & Handover', icon: CheckSquare },
  { id: 'reports' as DashboardTab, label: 'Reports', icon: FileText },
  { id: 'documentation' as DashboardTab, label: 'Documentation', icon: BookOpen },
  { id: 'upload' as DashboardTab, label: 'Data Upload', icon: Upload },
  { id: 'settings' as DashboardTab, label: 'Settings', icon: Settings },
];

// Development-only navigation items
const developmentItems = process.env.NODE_ENV === 'development' ? [
  { id: 'devtools-demo' as DashboardTab, label: 'ðŸ› ï¸ DevTools Demo', icon: Wrench, isDevelopmentOnly: true },
] : [];

export default function Sidebar({ activeTab, onTabChange, isOpen, onClose }: SidebarProps) {
  const { user, logoutMutation } = useAuth();
  const [, setLocation] = useLocation();

  const handleTabChange = (tab: DashboardTab) => {
    // Handle widget dashboard navigation with routing
    if (tab === 'widget-dashboards') {
      setLocation('/dashboards/1');
    } else if (tab === 'widget-builder') {
      setLocation('/dashboards/builder');
    } else if (tab === 'widget-templates') {
      setLocation('/dashboards/templates');
    } else {
      // For other tabs, use the normal tab change callback
      onTabChange(tab);
    }

    // Close mobile sidebar when tab is selected
    if (onClose && window.innerWidth < 1024) {
      onClose();
    }
  };

  const getUserInitials = (fullName: string | undefined) => {
    if (!fullName) return 'U';
    return fullName
      .split(' ')
      .map(name => name.charAt(0).toUpperCase())
      .join('')
      .slice(0, 2);
  };

  const handleLogout = () => {
    logoutMutation.mutate();
  };

  return (
    <aside className="w-64 h-screen bg-sidebar shadow-lg flex-shrink-0 flex flex-col sidebar-dark">
      {/* Header */}
      <div className="p-4 sm:p-6 sidebar-header">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="w-8 sm:w-10 h-8 sm:h-10 sidebar-logo flex items-center justify-center">
              <Store className="text-sm sm:text-lg font-bold" />
            </div>
            <div className="hidden sm:block">
              <h1 className="text-base sm:text-lg sidebar-title">LF-SMS</h1>
              <p className="text-xs sidebar-subtitle">Store Management</p>
            </div>
          </div>

          {/* Mobile Close Button */}
          {onClose && (
            <button
              onClick={onClose}
              className="lg:hidden p-2 rounded-md hover:bg-sidebar-hover transition-colors"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          )}
        </div>
      </div>

      {/* Navigation */}
      <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
        {navigationItems.map((item) => {
          const Icon = item.icon;
          const isActive = activeTab === item.id;

          return (
            <button
              key={item.id}
              onClick={() => handleTabChange(item.id)}
              className={`nav-link w-full ${
                isActive ? 'nav-link-active' : 'nav-link-inactive'
              }`}
            >
              <Icon className="w-4 sm:w-5 h-4 sm:h-5 text-current flex-shrink-0" />
              <span className="hidden sm:inline truncate">{item.label}</span>
            </button>
          );
        })}

        {/* Development-only items */}
        {developmentItems.length > 0 && (
          <>
            <div className="border-t border-gray-600 my-4"></div>
            <div className="text-xs text-gray-400 uppercase tracking-wide px-2 mb-2">
              Development
            </div>
            {developmentItems.map((item) => {
              const Icon = item.icon;
              const isActive = activeTab === item.id;

              return (
                <button
                  key={item.id}
                  onClick={() => handleTabChange(item.id)}
                  className={`nav-link w-full ${
                    isActive ? 'nav-link-active' : 'nav-link-inactive'
                  } opacity-80`}
                >
                  <Icon className="w-4 sm:w-5 h-4 sm:h-5 text-current flex-shrink-0" />
                  <span className="hidden sm:inline truncate">{item.label}</span>
                </button>
              );
            })}
          </>
        )}
      </nav>

      {/* User Profile */}
      <div className="p-3 sm:p-4 border-t border-border bg-muted/20">
        <div className="flex items-center space-x-2 sm:space-x-3">
          <div className="w-7 sm:w-8 h-7 sm:h-8 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
            <span className="text-white text-xs sm:text-sm font-medium">
              {getUserInitials(user?.fullName)}
            </span>
          </div>
          <div className="flex-1 min-w-0 hidden sm:block">
            <p className="text-xs sm:text-sm font-medium text-foreground truncate">
              {user?.fullName || 'User'}
            </p>
            <p className="text-xs text-muted-foreground truncate">{user?.role || 'Role'}</p>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={handleLogout}
            disabled={logoutMutation.isPending}
            className="text-muted-foreground hover:text-foreground p-1 sm:p-2"
            title={logoutMutation.isPending ? "Logging out..." : "Logout"}
          >
            <LogOut className="w-3 sm:w-4 h-3 sm:h-4" />
          </Button>
        </div>
      </div>
    </aside>
  );
}
/**
 * Multer Upload Configuration
 * Feature: 025-product-image-management
 *
 * Configures Multer for secure file uploads with validation
 */

import multer from 'multer';
import type { Request } from 'express';

/**
 * Validate file type using magic number (not just MIME type)
 */
function validateFileType(
  req: Request,
  file: Express.Multer.File,
  cb: multer.FileFilterCallback
): void {
  // Accept only image MIME types
  const allowedMimes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];

  if (!allowedMimes.includes(file.mimetype)) {
    return cb(new Error('Only JPG, JPEG, PNG, WEBP formats accepted'));
  }

  cb(null, true);
}

/**
 * Multer configuration for product images
 * - Memory storage (no temp files)
 * - Max 5 files per request
 * - Max 10MB per file
 * - File type validation
 */
export const uploadImages = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
    files: 5, // Max 5 images
  },
  fileFilter: validateFileType,
});

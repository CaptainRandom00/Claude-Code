/**
 * API Endpoint Picker Component
 * Feature: 028-build-a-widget (User Story 3 - T062)
 *
 * Displays available API endpoints for widget data source selection
 */

import { useApiEndpoints, type ApiEndpoint } from '@/hooks/use-api-metadata';
import { Loader2, Database, CheckCircle } from 'lucide-react';
import { ScrollArea } from '@/components/ui/scroll-area';

interface ApiEndpointPickerProps {
  selectedEndpointId: number | null;
  onEndpointSelect: (endpoint: ApiEndpoint) => void;
}

export function ApiEndpointPicker({ selectedEndpointId, onEndpointSelect }: ApiEndpointPickerProps) {
  const { data: endpoints, isLoading, error } = useApiEndpoints();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8" data-testid="api-endpoint-picker">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-4 text-center text-destructive" data-testid="api-endpoint-picker">
        Failed to load API endpoints: {error instanceof Error ? error.message : 'Unknown error'}
      </div>
    );
  }

  if (!endpoints || endpoints.length === 0) {
    return (
      <div className="p-8 text-center text-muted-foreground" data-testid="api-endpoint-picker">
        No API endpoints available
      </div>
    );
  }

  return (
    <div data-testid="api-endpoint-picker" className="space-y-4">
      <div>
        <h3 className="font-semibold text-lg mb-2">Select Data Source</h3>
        <p className="text-sm text-muted-foreground">
          Choose an API endpoint to fetch data from
        </p>
      </div>

      <ScrollArea className="h-[400px] border rounded-lg">
        <div className="p-4 space-y-2">
          {endpoints.map((endpoint) => (
            <button
              key={endpoint.id}
              onClick={() => onEndpointSelect(endpoint)}
              className={`w-full text-left p-4 rounded-lg border transition-all ${
                selectedEndpointId === endpoint.id
                  ? 'border-primary bg-primary/5'
                  : 'border-border hover:border-primary/50 hover:bg-accent'
              }`}
              data-testid={`api-endpoint-option-${endpoint.id}`}
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    <Database className="h-4 w-4 text-muted-foreground" />
                    <span
                      className="font-mono text-sm font-semibold"
                      data-testid="endpoint-name"
                    >
                      {endpoint.httpMethod} {endpoint.endpointPath}
                    </span>
                  </div>
                  <p className="text-sm text-muted-foreground" data-testid="endpoint-description">
                    {endpoint.description}
                  </p>
                  {endpoint.availableFields && endpoint.availableFields.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-1">
                      {endpoint.availableFields.slice(0, 5).map((field) => (
                        <span
                          key={field}
                          className="text-xs bg-muted px-2 py-0.5 rounded"
                        >
                          {field}
                        </span>
                      ))}
                      {endpoint.availableFields.length > 5 && (
                        <span className="text-xs text-muted-foreground">
                          +{endpoint.availableFields.length - 5} more
                        </span>
                      )}
                    </div>
                  )}
                </div>
                {selectedEndpointId === endpoint.id && (
                  <CheckCircle className="h-5 w-5 text-primary flex-shrink-0 ml-2" />
                )}
              </div>
            </button>
          ))}
        </div>
      </ScrollArea>
    </div>
  );
}

/**
 * Dashboard Viewer Page
 * Feature: 028-build-a-widget
 *
 * Main dashboard page for viewing pre-configured dashboards with live widgets
 * Implements responsive grid layout with react-grid-layout (per spec.md FR-021)
 */

import React, { useEffect, useState } from 'react';
import { useRoute } from 'wouter';
import { useQuery } from '@tanstack/react-query';
import { Responsive, WidthProvider, Layout } from 'react-grid-layout';
import { WidgetContainer } from '@/components/widgets/base/WidgetContainer';
import { WidgetFactory } from '@/components/widgets/WidgetFactory';
import { useWidgetData } from '@/hooks/useWidgetData';
import { BREAKPOINTS, COLUMNS } from '@/types/widget-types';
import type { WidgetDefinition, DashboardWidget } from '@/types/widget-types';

const ResponsiveGridLayout = WidthProvider(Responsive);

interface Dashboard {
  id: number;
  name: string;
  description: string | null;
  widgets: DashboardWidget[];
}

/**
 * Fetch dashboard data with widgets
 */
async function fetchDashboard(id: number): Promise<Dashboard> {
  const response = await fetch(`/api/widgets/dashboards/${id}`);

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to fetch dashboard');
  }

  return response.json();
}

/**
 * Individual widget component with data fetching
 */
function Widget({ widget }: { widget: DashboardWidget }) {
  const {
    data,
    lastFetched,
    isLoading,
    isError,
    error,
    refetch,
  } = useWidgetData({
    widgetDefinition: widget.widgetDefinition as WidgetDefinition,
  });

  return (
    <WidgetContainer
      widgetId={widget.id}
      title={widget.widgetDefinition.name}
      loading={isLoading}
      error={error}
      lastFetched={lastFetched}
      onRefresh={() => refetch()}
    >
      <WidgetFactory
        widgetType={widget.widgetDefinition.widgetType}
        data={data}
        visualizationConfig={widget.widgetDefinition.visualizationConfig}
      />
    </WidgetContainer>
  );
}

/**
 * Main Dashboard Viewer Component
 */
export default function DashboardViewer() {
  const [match, params] = useRoute('/dashboards/:id');
  const dashboardId = params?.id ? parseInt(params.id) : 1; // Default to dashboard 1

  // Fetch dashboard configuration
  const {
    data: dashboard,
    isLoading: isDashboardLoading,
    isError: isDashboardError,
    error: dashboardError,
  } = useQuery({
    queryKey: ['dashboard', dashboardId],
    queryFn: () => fetchDashboard(dashboardId),
  });

  // Generate layouts from widget configurations
  const [layouts, setLayouts] = useState<{ [key: string]: Layout[] }>({});

  useEffect(() => {
    if (!dashboard?.widgets) return;

    // Convert dashboard widgets to react-grid-layout layouts
    const generatedLayouts: { [key: string]: Layout[] } = {};

    Object.keys(BREAKPOINTS).forEach((breakpoint) => {
      generatedLayouts[breakpoint] = dashboard.widgets.map((widget, index) => {
        // Get layout for this breakpoint, or fall back to default
        const layout = widget.layouts?.find((l) => l.breakpoint === breakpoint);

        if (layout) {
          return {
            i: widget.id.toString(),
            x: layout.x,
            y: layout.y,
            w: layout.w,
            h: layout.h,
            minW: layout.minW || undefined,
            minH: layout.minH || undefined,
          };
        }

        // Default layout (2 columns wide, stacked vertically)
        const cols = COLUMNS[breakpoint as keyof typeof COLUMNS];
        const defaultWidth = Math.min(2, cols);

        return {
          i: widget.id.toString(),
          x: (index * defaultWidth) % cols,
          y: Math.floor((index * defaultWidth) / cols) * 3,
          w: defaultWidth,
          h: 3,
          minW: 1,
          minH: 2,
        };
      });
    });

    setLayouts(generatedLayouts);
  }, [dashboard]);

  // Loading state
  if (isDashboardLoading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="flex flex-col items-center gap-3">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          <p className="text-muted-foreground">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  // Error state
  if (isDashboardError || !dashboard) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center max-w-md">
          <h2 className="text-2xl font-bold text-destructive mb-2">
            Failed to load dashboard
          </h2>
          <p className="text-muted-foreground">
            {dashboardError instanceof Error
              ? dashboardError.message
              : 'An unknown error occurred'}
          </p>
        </div>
      </div>
    );
  }

  return (
    <div data-testid="dashboard-viewer" className="p-6">
      {/* Dashboard Header */}
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-foreground mb-2">
          {dashboard.name}
        </h1>
        {dashboard.description && (
          <p className="text-muted-foreground">{dashboard.description}</p>
        )}
      </div>

      {/* Widgets Grid */}
      {!dashboard.widgets || dashboard.widgets.length === 0 ? (
        <div className="flex items-center justify-center h-64 border-2 border-dashed border-muted rounded-lg">
          <p className="text-muted-foreground">
            No widgets configured for this dashboard
          </p>
        </div>
      ) : (
        <ResponsiveGridLayout
          className="layout"
          layouts={layouts}
          breakpoints={BREAKPOINTS}
          cols={COLUMNS}
          rowHeight={100}
          isDraggable={false} // View-only mode for User Story 1
          isResizable={false} // View-only mode for User Story 1
          margin={[16, 16]}
          containerPadding={[0, 0]}
        >
          {dashboard.widgets.map((widget) => (
            <div key={widget.id.toString()} className="h-full">
              <Widget widget={widget} />
            </div>
          ))}
        </ResponsiveGridLayout>
      )}
    </div>
  );
}

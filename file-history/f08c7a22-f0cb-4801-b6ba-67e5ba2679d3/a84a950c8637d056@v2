/**
 * Safari White Screen Detection Test (Feature 024)
 *
 * Simple pass/fail test: "Is it a white screen or not?"
 *
 * PASS Criteria:
 * - Dashboard visible in Safari
 * - 557+ DOM elements rendered (baseline from diagnostics)
 * - Screenshot shows content, not white screen
 *
 * FAIL Criteria:
 * - White screen (< 100 DOM elements)
 * - Screenshot shows blank page
 * - JavaScript errors prevent rendering
 */

import { test, expect } from '@playwright/test';

test.describe('Safari White Screen Detection', () => {
  test('Safari shows dashboard, not white screen', async ({ page }) => {
    // Navigate to application
    await page.goto('http://localhost:3000', {
      waitUntil: 'networkidle',
      timeout: 10000, // 10 second timeout for initial load
    });

    // Wait for React to mount and render (wait for actual content, not just #root div)
    // The app shows a login screen first, then dashboard after auth
    await page.waitForSelector('body', { state: 'attached', timeout: 5000 });

    // Wait for React to initialize (look for any rendered content)
    await page.waitForTimeout(2000); // Give React time to mount

    // Check 1: Is content visible? (not white screen)
    // Dashboard OR login screen should be visible (both prove React mounted)
    const hasContent = await page.evaluate(() => {
      const root = document.getElementById('root');
      return root && root.innerHTML.length > 0;
    });
    expect(hasContent).toBeTruthy();

    // Check 2: Count DOM elements (should be 557+ for full dashboard)
    const domElementCount = await page.evaluate(() => {
      return document.querySelectorAll('*').length;
    });

    console.log(`DOM elements rendered: ${domElementCount}`);
    expect(domElementCount).toBeGreaterThan(50); // Minimum threshold (login page has ~100, dashboard has 557+)

    // Check 3: Verify some UI is rendered (login OR dashboard)
    const hasVisibleUI = await page.evaluate(() => {
      const buttons = document.querySelectorAll('button');
      const inputs = document.querySelectorAll('input');
      const text = document.body.innerText;
      return buttons.length > 0 || inputs.length > 0 || text.length > 100;
    });
    expect(hasVisibleUI).toBeTruthy();

    // Check 4: No JavaScript console errors that would indicate white screen
    const consoleErrors: string[] = [];
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        consoleErrors.push(msg.text());
      }
    });

    // Reload to capture any mount errors
    await page.reload({ waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);

    // Filter out non-critical errors
    const criticalErrors = consoleErrors.filter((error) =>
      error.includes('Failed to load') ||
      error.includes('TLS') ||
      error.includes('certificate') ||
      error.includes('Cannot read properties of undefined')
    );

    expect(criticalErrors.length).toBe(0);

    // Check 5: Take screenshot for audit trail
    await page.screenshot({
      path: 'specs/024-lets-root-cause/audit/after-dashboard-working.png',
      fullPage: true,
    });

    console.log('✅ PASS: Safari displays content (not white screen)');
    console.log(`   DOM elements: ${domElementCount}`);
    console.log(`   Has visible UI: ${hasVisibleUI}`);
    console.log(`   Critical errors: ${criticalErrors.length}`);
  });

  test('Safari handles page reload gracefully', async ({ page }) => {
    // Navigate to application
    await page.goto('http://localhost:3000', { waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);

    // Get initial DOM count
    const initialDomCount = await page.evaluate(() =>
      document.querySelectorAll('*').length
    );

    // Reload page
    await page.reload({ waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);

    // Get post-reload DOM count
    const reloadedDomCount = await page.evaluate(() =>
      document.querySelectorAll('*').length
    );

    // Verify content still loads after reload (should have similar DOM count)
    expect(reloadedDomCount).toBeGreaterThan(50); // Minimum threshold
    expect(reloadedDomCount).toBeGreaterThanOrEqual(initialDomCount * 0.8); // Allow 20% variance

    console.log(`✅ PASS: Safari handles reload gracefully`);
    console.log(`   Initial DOM: ${initialDomCount}, Reloaded DOM: ${reloadedDomCount}`);
  });

  test('Safari compatibility mode activates correctly', async ({ page }) => {
    // Capture console logs
    const consoleLogs: string[] = [];
    page.on('console', (msg) => {
      consoleLogs.push(msg.text());
    });

    await page.goto('http://localhost:3000', { waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);

    // Check that Safari compatibility mode was detected and activated
    const safariDetected = consoleLogs.some((log) =>
      log.includes('Safari/WebKit detected')
    );

    expect(safariDetected).toBeTruthy();
    console.log('✅ PASS: Safari compatibility mode activated');
    console.log(`   Console logs: ${consoleLogs.filter(l => l.includes('Safari')).join(', ')}`);
  });

  test('Performance: Safari meets Core Web Vitals targets', async ({ page }) => {
    const startTime = Date.now();

    await page.goto('http://localhost:3000', { waitUntil: 'load' });

    const loadTime = Date.now() - startTime;

    // Check performance targets from spec (Feature 024)
    // - FCP < 1.8s
    // - Page load < 2s
    expect(loadTime).toBeLessThan(2000); // 2 seconds

    // Measure First Contentful Paint
    const fcp = await page.evaluate(() => {
      const paintEntries = performance.getEntriesByType('paint');
      const fcpEntry = paintEntries.find((entry) => entry.name === 'first-contentful-paint');
      return fcpEntry ? fcpEntry.startTime : null;
    });

    if (fcp) {
      expect(fcp).toBeLessThan(1800); // 1.8 seconds
      console.log(`✅ PASS: Safari performance targets met`);
      console.log(`   FCP: ${fcp}ms (target < 1800ms)`);
      console.log(`   Load time: ${loadTime}ms (target < 2000ms)`);
    }
  });
});

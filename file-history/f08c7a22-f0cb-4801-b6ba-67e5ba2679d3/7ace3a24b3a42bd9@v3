/**
 * Calculation Builder Component
 * Feature: 028-build-a-widget (User Story 3 - T063)
 *
 * Allows users to configure calculations (Sum, Average, Count, Min, Max)
 * for widget data processing
 */

import { useState } from 'react';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  ConditionalFormattingBuilder,
  type ConditionalFormattingRule,
} from './ConditionalFormattingBuilder';

interface CalculationBuilderProps {
  availableFields: string[];
  onCalculationChange: (calculation: CalculationConfig) => void;
}

export interface CalculationConfig {
  aggregations: Array<{
    type: string;
    field?: string;
    alias: string;
  }>;
  comparisons?: Array<{
    type: 'percent_change' | 'difference' | 'ratio';
    currentField: string;
    comparisonField: string;
  }>;
  conditionalFormatting?: Array<{
    field: string;
    operator: 'gt' | 'gte' | 'lt' | 'lte' | 'eq' | 'ne' | 'between';
    value?: number;
    min?: number;
    max?: number;
    color?: string;
    backgroundColor?: string;
    icon?: string;
  }>;
}

const AGGREGATION_TYPES = [
  { value: 'sum', label: 'Sum', requiresField: true },
  { value: 'average', label: 'Average', requiresField: true },
  { value: 'count', label: 'Count', requiresField: false },
  { value: 'min', label: 'Min', requiresField: true },
  { value: 'max', label: 'Max', requiresField: true },
];

export function CalculationBuilder({ availableFields, onCalculationChange }: CalculationBuilderProps) {
  const [aggregationType, setAggregationType] = useState<string>('');
  const [selectedField, setSelectedField] = useState<string>('');

  // User Story 5: Comparison mode state
  const [comparisonMode, setComparisonMode] = useState(false);
  const [comparisonType, setComparisonType] = useState<'percent_change' | 'difference' | 'ratio'>('percent_change');

  // User Story 5: Conditional formatting state
  const [formattingRules, setFormattingRules] = useState<ConditionalFormattingRule[]>([]);

  // Helper to emit full config with optional comparisons and formatting
  const emitConfig = (agg: any, field?: string) => {
    const config: CalculationConfig = {
      aggregations: [agg],
    };

    // Add comparisons if comparison mode is enabled
    if (comparisonMode && field) {
      config.comparisons = [{
        type: comparisonType,
        currentField: field,
        comparisonField: `${field}_previous`, // Assuming previous period field naming
      }];
    }

    // Add conditional formatting if any rules configured
    if (formattingRules.length > 0) {
      config.conditionalFormatting = formattingRules;
    }

    onCalculationChange(config);
  };

  const handleFormattingRulesChange = (rules: ConditionalFormattingRule[]) => {
    setFormattingRules(rules);

    // Re-emit config if everything is configured
    if (aggregationType && selectedField) {
      emitConfig({
        type: aggregationType,
        field: selectedField,
        alias: `${aggregationType}_${selectedField}`,
      }, selectedField);
    }
  };

  const handleAggregationChange = (type: string) => {
    setAggregationType(type);

    const requiresField = AGGREGATION_TYPES.find(a => a.value === type)?.requiresField;

    // If type doesn't require field, emit immediately
    if (!requiresField) {
      emitConfig({ type, alias: `${type}_value` });
      return;
    }

    // If field already selected, emit config
    if (selectedField) {
      emitConfig({ type, field: selectedField, alias: `${type}_${selectedField}` }, selectedField);
    }
  };

  const handleFieldChange = (field: string) => {
    setSelectedField(field);

    if (aggregationType) {
      emitConfig({
        type: aggregationType,
        field,
        alias: `${aggregationType}_${field}`,
      }, field);
    }
  };

  const handleComparisonTypeChange = (type: 'percent_change' | 'difference' | 'ratio') => {
    setComparisonType(type);

    // Re-emit config with new comparison type if everything is configured
    if (aggregationType && selectedField) {
      const agg = {
        type: aggregationType,
        field: selectedField,
        alias: `${aggregationType}_${selectedField}`,
      };

      const config: CalculationConfig = { aggregations: [agg] };
      if (comparisonMode) {
        config.comparisons = [{
          type,
          currentField: selectedField,
          comparisonField: `${selectedField}_previous`,
        }];
      }
      onCalculationChange(config);
    }
  };

  const handleComparisonModeToggle = (enabled: boolean) => {
    setComparisonMode(enabled);

    // Re-emit config with or without comparisons
    if (aggregationType && selectedField) {
      emitConfig({
        type: aggregationType,
        field: selectedField,
        alias: `${aggregationType}_${selectedField}`,
      }, selectedField);
    }
  };

  const selectedAggregation = AGGREGATION_TYPES.find(a => a.value === aggregationType);
  const showFieldSelector = selectedAggregation?.requiresField && availableFields.length > 0;

  return (
    <div data-testid="calculation-builder" className="space-y-4">
      <div>
        <h3 className="font-semibold text-lg mb-2">Configure Calculation</h3>
        <p className="text-sm text-muted-foreground">
          Choose how to aggregate the data
        </p>
      </div>

      {/* Aggregation Type Selector */}
      <div className="space-y-2">
        <Label htmlFor="aggregation-type">Aggregation Type</Label>
        <Select
          value={aggregationType}
          onValueChange={handleAggregationChange}
        >
          <SelectTrigger id="aggregation-type" data-testid="aggregation-type-select">
            <SelectValue placeholder="Select aggregation type" />
          </SelectTrigger>
          <SelectContent>
            {AGGREGATION_TYPES.map((agg) => (
              <SelectItem
                key={agg.value}
                value={agg.value}
                data-testid={`aggregation-option-${agg.value}`}
              >
                {agg.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Field Selector (for Sum, Average, Min, Max) */}
      {showFieldSelector && (
        <div className="space-y-2">
          <Label htmlFor="aggregation-field">Field to Aggregate</Label>
          <Select
            value={selectedField}
            onValueChange={handleFieldChange}
          >
            <SelectTrigger id="aggregation-field" data-testid="aggregation-field-select">
              <SelectValue placeholder="Select field" />
            </SelectTrigger>
            <SelectContent>
              {availableFields.map((field) => (
                <SelectItem
                  key={field}
                  value={field}
                  data-testid={`field-option-${field}`}
                >
                  {field}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      )}

      {/* User Story 5: Comparison Mode Toggle */}
      {aggregationType && selectedField && (
        <div className="space-y-4 pt-4 border-t">
          <div className="flex items-center justify-between">
            <div className="space-y-0.5">
              <Label htmlFor="comparison-mode">Comparison Mode</Label>
              <p className="text-sm text-muted-foreground">
                Compare values with previous period
              </p>
            </div>
            <Switch
              id="comparison-mode"
              checked={comparisonMode}
              onCheckedChange={handleComparisonModeToggle}
              data-testid="comparison-mode-toggle"
            />
          </div>

          {/* Comparison Type Selector */}
          {comparisonMode && (
            <div className="space-y-2">
              <Label htmlFor="comparison-type">Comparison Type</Label>
              <Select
                value={comparisonType}
                onValueChange={handleComparisonTypeChange}
              >
                <SelectTrigger id="comparison-type" data-testid="comparison-type-select">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="percent_change" data-testid="comparison-option-percent_change">
                    Percent Change (%)
                  </SelectItem>
                  <SelectItem value="difference" data-testid="comparison-option-difference">
                    Difference (Absolute)
                  </SelectItem>
                  <SelectItem value="ratio" data-testid="comparison-option-ratio">
                    Ratio
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
          )}
        </div>
      )}

      {/* Calculation Summary */}
      {aggregationType && (
        <div className="p-3 bg-muted rounded-lg">
          <p className="text-sm font-medium">Calculation Preview:</p>
          <p className="text-sm text-muted-foreground mt-1">
            {selectedAggregation?.label}
            {selectedField && ` of ${selectedField}`}
            {comparisonMode && (
              <>
                {' '}&bull;{' '}
                {comparisonType === 'percent_change' && 'Percent Change'}
                {comparisonType === 'difference' && 'Difference'}
                {comparisonType === 'ratio' && 'Ratio'}
                {' '}vs Previous
              </>
            )}
          </p>
        </div>
      )}

      {/* User Story 5: Conditional Formatting Builder */}
      {aggregationType && selectedField && (
        <div className="pt-4 border-t">
          <ConditionalFormattingBuilder
            availableFields={availableFields}
            rules={formattingRules}
            onRulesChange={handleFormattingRulesChange}
          />
        </div>
      )}
    </div>
  );
}

import { NextRequest, NextResponse } from 'next/server';
import { query } from '@/lib/db';
import nodemailer from 'nodemailer';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { name, email, company, phone, service, budget, timeline, message } = body;

    // Validate input
    if (!name || !email || !message || !service) {
      return NextResponse.json(
        { error: 'Name, email, service, and message are required' },
        { status: 400 }
      );
    }

    // Save to database
    try {
      await query(
        `INSERT INTO contact_submissions
         (name, email, company, phone, service, budget, timeline, message, created_at)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())
         RETURNING id`,
        [name, email, company || null, phone || null, service, budget || null, timeline || null, message]
      );
    } catch (dbError) {
      console.error('Database error:', dbError);
      // Continue even if database fails - we'll still try to send the email
    }

    // Send email notification
    if (process.env.SMTP_HOST && process.env.SMTP_USER && process.env.SMTP_PASS) {
      try {
        const transporter = nodemailer.createTransporter({
          host: process.env.SMTP_HOST,
          port: parseInt(process.env.SMTP_PORT || '587'),
          secure: false,
          auth: {
            user: process.env.SMTP_USER,
            pass: process.env.SMTP_PASS,
          },
        });

        // Format service name for email
        const serviceNames: { [key: string]: string } = {
          'custom-software': 'Custom Software Development',
          'web-development': 'Web Development',
          'mobile-apps': 'Mobile Apps',
          'cloud-solutions': 'Cloud Solutions',
          'ai-integration': 'AI Integration',
          'consulting': 'Consulting & Support'
        };

        // Format budget range for email
        const budgetRanges: { [key: string]: string } = {
          'under-10k': 'Under £10,000',
          '10k-25k': '£10,000 - £25,000',
          '25k-50k': '£25,000 - £50,000',
          '50k-100k': '£50,000 - £100,000',
          'over-100k': 'Over £100,000'
        };

        // Format timeline for email
        const timelines: { [key: string]: string } = {
          'asap': 'ASAP',
          '1-3-months': '1-3 months',
          '3-6-months': '3-6 months',
          '6-12-months': '6-12 months',
          'flexible': 'Flexible'
        };

        await transporter.sendMail({
          from: process.env.SMTP_USER,
          to: process.env.SMTP_USER, // Send to yourself
          replyTo: email,
          subject: `New ${serviceNames[service] || 'Service'} Inquiry from ${name}`,
          html: `
            <h2>New Contact Form Submission</h2>
            <hr style="border: 1px solid #e5e5e5; margin: 20px 0;">

            <h3>Contact Information</h3>
            <p><strong>Name:</strong> ${name}</p>
            <p><strong>Email:</strong> <a href="mailto:${email}">${email}</a></p>
            <p><strong>Company:</strong> ${company || 'Not provided'}</p>
            <p><strong>Phone:</strong> ${phone || 'Not provided'}</p>

            <h3>Project Details</h3>
            <p><strong>Service Needed:</strong> ${serviceNames[service] || service}</p>
            <p><strong>Budget Range:</strong> ${budgetRanges[budget] || 'Not specified'}</p>
            <p><strong>Timeline:</strong> ${timelines[timeline] || 'Not specified'}</p>

            <h3>Message</h3>
            <p style="white-space: pre-wrap;">${message}</p>

            <hr style="border: 1px solid #e5e5e5; margin: 20px 0;">
            <p style="font-size: 12px; color: #666;">
              This email was sent from the Byte Bridges contact form.
              Reply directly to this email to respond to ${name}.
            </p>
          `,
        });
      } catch (emailError) {
        console.error('Email error:', emailError);
        // Continue even if email fails
      }
    }

    return NextResponse.json(
      { message: 'Contact form submitted successfully' },
      { status: 200 }
    );
  } catch (error) {
    console.error('Contact form error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

-- Migration: Create contact_submissions table
-- Created: 2025-11-08
-- Complies with ICO data retention guidelines

CREATE TABLE IF NOT EXISTS contact_submissions (
  id SERIAL PRIMARY KEY,
  -- Contact Information
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(50),
  company VARCHAR(255),

  -- Project Details
  service_interest TEXT[], -- Array of interested services
  budget_range VARCHAR(50), -- e.g., "$10k-$25k", "$25k-$50k", "$50k-$100k", "$100k+"
  timeline VARCHAR(50), -- e.g., "Immediate", "1-3 months", "3-6 months", "6+ months"
  message TEXT NOT NULL,

  -- Metadata
  source VARCHAR(100), -- Which page/form the submission came from
  utm_source VARCHAR(100), -- Marketing tracking
  utm_medium VARCHAR(100),
  utm_campaign VARCHAR(100),

  -- Status & Processing
  status VARCHAR(50) DEFAULT 'new', -- 'new', 'contacted', 'in_progress', 'converted', 'closed'
  admin_notes TEXT,
  contacted_at TIMESTAMP WITH TIME ZONE,

  -- GDPR/ICO Compliance
  gdpr_consent BOOLEAN DEFAULT false, -- User consented to data processing
  marketing_consent BOOLEAN DEFAULT false, -- User consented to marketing emails
  retention_expiry TIMESTAMP WITH TIME ZONE, -- When this record should be deleted per ICO

  -- Timestamps
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_contact_submissions_email ON contact_submissions(email);
CREATE INDEX IF NOT EXISTS idx_contact_submissions_status ON contact_submissions(status, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_contact_submissions_created ON contact_submissions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_contact_submissions_retention ON contact_submissions(retention_expiry);
CREATE INDEX IF NOT EXISTS idx_contact_submissions_service ON contact_submissions USING GIN(service_interest);

-- Create trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_contact_submissions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_contact_submissions_updated_at
  BEFORE UPDATE ON contact_submissions
  FOR EACH ROW
  EXECUTE FUNCTION update_contact_submissions_updated_at();

-- Create trigger to set retention_expiry on insert (ICO: 3 years default)
CREATE OR REPLACE FUNCTION set_contact_submission_retention()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.retention_expiry IS NULL THEN
    NEW.retention_expiry = NEW.created_at + INTERVAL '3 years';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_contact_submission_retention
  BEFORE INSERT ON contact_submissions
  FOR EACH ROW
  EXECUTE FUNCTION set_contact_submission_retention();

-- Add comments for documentation
COMMENT ON TABLE contact_submissions IS 'Stores contact form submissions with ICO-compliant data retention';
COMMENT ON COLUMN contact_submissions.retention_expiry IS 'Date when this record should be deleted per ICO guidelines (default: 3 years from submission)';
COMMENT ON COLUMN contact_submissions.gdpr_consent IS 'User explicitly consented to data processing (required for GDPR compliance)';
COMMENT ON COLUMN contact_submissions.marketing_consent IS 'User opted in to receive marketing communications';
